rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // User profiles
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if false; // Users cannot be deleted via client
    }
    
    // User wallets
    match /userWallets/{walletId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.balance == 0 &&
        request.resource.data.status == 'active';
      allow update: if isAdmin(); // Only admin can update wallets directly
      allow delete: if false; // Wallets cannot be deleted
    }
    
    // Recharge transactions
    match /rechargeTransactions/{transactionId} {
      allow read: if isAuthenticated() && 
        (get(/databases/$(database)/documents/userWallets/$(resource.data.walletId)).data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
        get(/databases/$(database)/documents/userWallets/$(request.resource.data.walletId)).data.userId == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isAdmin() || 
        (isAuthenticated() && 
         get(/databases/$(database)/documents/userWallets/$(resource.data.walletId)).data.userId == request.auth.uid &&
         resource.data.status == 'pending' &&
         request.resource.data.status in ['processing', 'cancelled']);
      allow delete: if false; // Transactions cannot be deleted
    }
    
    // Wallet payment methods
    match /walletPaymentMethods/{methodId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Wallet booking payments
    match /walletBookingPayments/{paymentId} {
      allow read: if isAuthenticated() && 
        (get(/databases/$(database)/documents/userWallets/$(resource.data.walletId)).data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
        get(/databases/$(database)/documents/userWallets/$(request.resource.data.walletId)).data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if false; // Booking payments cannot be deleted
    }
    
    // Tours
    match /tours/{tourId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Hotels
    match /hotels/{hotelId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Activities
    match /activities/{activityId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Drivers
    match /drivers/{driverId} {
      allow read: if true; // Public access for browsing
      allow create: if isAuthenticated() && request.auth.uid == driverId;
      allow update: if isOwner(driverId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Vehicles
    match /vehicles/{vehicleId} {
      allow read: if true; // Public access for browsing
      allow write: if isAuthenticated() && 
        (resource == null || resource.data.driverId == request.auth.uid || isAdmin());
    }
    
    // Bookings
    match /bookings/{bookingId} {
      allow read: if true; // Temporarily allow public read for testing
      allow create: if true; // Temporarily allow anyone to create bookings for testing
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         resource.data.driverId == request.auth.uid || 
         isAdmin());
      allow delete: if isAdmin();
    }
    
    // Reviews
    match /reviews/{reviewId} {
      allow read: if true; // Public access
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // CMS content
    match /cmsContent/{contentId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Articles/Blog
    match /articles/{articleId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Social media posts
    match /socialMediaPosts/{postId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // AI recommendations
    match /aiRecommendations/{recommendationId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if false; // Recommendations are immutable
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Newsletter subscriptions
    match /newsletterSubscriptions/{subscriptionId} {
      allow read: if isAdmin();
      allow create: if true; // Anyone can subscribe
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Wildlife data
    match /wildlifeData/{dataId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Destinations
    match /destinations/{destinationId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Analytics events
    match /analyticsEvents/{eventId} {
      allow read: if isAdmin();
      allow create: if true; // Anyone can create analytics events
      allow update: if false; // Events are immutable
      allow delete: if false; // Events cannot be deleted
    }
    
    // Admin notifications
    match /adminNotifications/{notificationId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // System settings
    match /systemSettings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Homepage Content Collections
    
    // Hero Content
    match /heroContent/{heroId} {
      allow read: if true; // Public access for website
      allow write: if isAdmin(); // Only admin can modify
    }

    // Hero Slides
    match /hero_slides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Travel Packages
    match /travelPackages/{packageId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admin can modify
    }

    // Travel Packages
    match /travel_packages/{packageId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Featured Destinations
    match /featuredDestinations/{destinationId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admin can modify
    }
    
    // Luxury Experiences
    match /luxuryExperiences/{experienceId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admin can modify
    }
    
    // Testimonials
    match /testimonials/{testimonialId} {
      allow read: if true; // Public access for approved testimonials
      allow create: if true; // Anyone can submit a testimonial
      allow update: if isAdmin(); // Only admin can update/approve
      allow delete: if isAdmin(); // Only admin can delete
    }
    
    // Why Choose Us
    match /whyChooseUs/{itemId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admin can modify
    }
    
    // Blog Posts
    match /blogPosts/{postId} {
      allow read: if true; // Public access for published posts
      allow write: if isAdmin(); // Only admin can modify
    }

    // Blog Posts
    match /blog_posts/{postId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // About Content
    match /aboutContent/{contentId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admin can modify
    }
    
    // Newsletter Sections
    match /newsletterContent/{contentId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admin can modify
    }

    // Logos
    match /logos/{logoId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
