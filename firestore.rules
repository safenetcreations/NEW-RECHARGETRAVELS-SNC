rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin');
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function driverAdminOnlyFields() {
      return [
        'current_status',
        'verified_level',
        'verification_date',
        'verified_by_admin_id',
        'is_sltda_approved',
        'suspension_reason'
      ];
    }

    function driverAdminOnlyDocFields() {
      return [
        'verification_status',
        'verified_by_admin_id',
        'verification_date',
        'rejection_reason'
      ];
    }

    function validDriverStatus(status) {
      return status in ['incomplete', 'pending_verification', 'verified', 'suspended', 'inactive'];
    }

    function isDriverSelfWrite(driverId) {
      return isOwner(driverId) && request.resource.data.user_id == driverId;
    }

    // Wild Tours Collection - Public read, admin write
    match /wildTours/{tourId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Wild Tours (Admin CMS) - Public read, admin write
    match /wildtours_tours/{tourId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Wild Tours Bookings - Public create for guest bookings, admin full
    match /wildtours_bookings/{bookingId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if true; // Allow guest bookings
      allow update, delete: if isAdmin();
    }

    // National Parks Tours Collection - Public read, admin write
    match /nationalparks_tours/{tourId} {
      allow read: if resource.data.is_active == true || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // National Parks Bookings - Public create, admin manage
    match /nationalparks_bookings/{bookingId} {
      // Admin can read all, users can read their own by email
      allow read: if isAdmin() || (isAuthenticated() && resource.data.email == request.auth.token.email);

      // Anyone can create a booking (public booking form)
      allow create: if true;

      // Only admins can update or delete
      allow update, delete: if isAdmin();
    }

    // National Parks Reviews - Public read, authenticated create
    match /nationalparks_reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Cultural Tours Collection - Public read, admin write
    match /cultural_tours/{tourId} {
      allow read: if resource.data.is_active == true || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Cultural Bookings - Authenticated create, admin full
    match /cultural_bookings/{bookingId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      // Allow guest bookings to be captured alongside authenticated users
      allow create: if (isAuthenticated() && request.resource.data.userId == request.auth.uid) || request.resource.data.userId == 'guest';
      allow update, delete: if isAdmin();
    }

    // Cultural Reviews - Public read, authenticated create
    match /cultural_reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Ramayana Tours Collection - Public read, admin write
    match /ramayana_tours/{tourId} {
      allow read: if resource.data.is_active == true || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Ramayana Bookings - Authenticated create, admin full
    match /ramayana_bookings/{bookingId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // Beach Tours Collection - Public read, admin write
    match /beach_tours/{tourId} {
      allow read: if resource.data.is_active == true || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Beach Bookings - Authenticated create, admin full
    match /beach_bookings/{bookingId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      // Allow guest bookings if userId is 'guest' or authenticated user
      allow create: if (isAuthenticated() && request.resource.data.userId == request.auth.uid) || request.resource.data.userId == 'guest';
      allow update, delete: if isAdmin();
    }

    // Ramayana Reviews - Public read, authenticated create
    match /ramayana_reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Users Collection - Own data or admin
    match /users/{userId} {
      // Users can read their own data, admins can read all
      allow read: if isOwner(userId) || isAdmin();

      // Users can only update their own data, admins can do anything
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // Bookings Collection - Authenticated users
    match /bookings/{bookingId} {
      // Users can read their own bookings, admins can read all
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      // Authenticated users can create bookings
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Only admins can update or delete bookings
      allow update, delete: if isAdmin();
    }

    // Activities Collection - Public read, admin write
    match /activities/{activityId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Hotels Collection - Public read, admin write
    match /hotels/{hotelId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Hotel Images - Public read, admin write
    match /hotel_images/{imageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Hotel Reviews - Public read, authenticated create, admin manage
    match /hotel_reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Room Types - Public read, admin write
    match /room_types/{roomTypeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Hotel Bookings - Public create, user read own, admin manage
    match /hotel_bookings/{bookingId} {
      // Users can read their own bookings, admin can read all
      allow read: if isAdmin() || (isAuthenticated() && resource.data.user_id == request.auth.uid);
      
      // Anyone can create a booking (guest checkout)
      allow create: if true;
      
      // Only admins can update or delete
      allow update, delete: if isAdmin();
    }

    // Property Listings - Public read approved, owner can create, admin manage
    match /property_listings/{listingId} {
      // Public can read approved listings, admin can read all
      allow read: if isAdmin() || resource.data.status == 'approved';
      
      // Anyone can create a listing (registration is open)
      allow create: if true;
      
      // Owners can update their own non-admin fields, admin can do anything
      allow update: if isAdmin() || (isAuthenticated() && resource.data.owner_email == request.auth.token.email);
      
      allow delete: if isAdmin();
    }

    // Tours Collection - Public read, admin write
    match /tours/{tourId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Destinations Collection - Public read, admin write
    match /destinations/{destinationId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Drivers Collection - Public read, admin write, authenticated create
    match /drivers/{driverId} {
      allow read: if true;

      // Allow admin to write directly (for seeding/management)
      // Allow public create for seeding
      allow create: if true;
      allow update, delete: if isAdmin();

      // Allow drivers to update their own profile (except admin-only fields)
      allow update: if isDriverSelfWrite(driverId)
                    && validDriverStatus(request.resource.data.current_status)
                    && !request.resource.data.diff(resource.data).changedKeys().hasAny(driverAdminOnlyFields());
    }

    // Driver Documents - Owner read/write limited fields, admin full
    match /driver_documents/{docId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.driver_id == request.auth.uid);

      allow create: if isAuthenticated()
                    && request.resource.data.driver_id == request.auth.uid
                    && request.resource.data.verification_status == 'pending'
                    && !request.resource.data.keys().hasAny(driverAdminOnlyDocFields());

      allow update: if isAdmin()
                    || (
                      isAuthenticated()
                      && resource.data.driver_id == request.auth.uid
                      && !request.resource.data.diff(resource.data).changedKeys().hasAny(driverAdminOnlyDocFields())
                    );

      allow delete: if isAdmin();
    }

    // Driver Photos - Owner read/write limited fields, admin full
    match /driver_photos/{photoId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.driver_id == request.auth.uid);

      allow create: if isAuthenticated()
                    && request.resource.data.driver_id == request.auth.uid
                    && request.resource.data.verification_status == 'pending';

      allow update: if isAdmin()
                    || (
                      isAuthenticated()
                      && resource.data.driver_id == request.auth.uid
                      && request.resource.data.verification_status == resource.data.verification_status
                    );

      allow delete: if isAdmin();
    }

    // Driver Availability - Owner/admin
    match /driver_availability/{availId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.driver_id == request.auth.uid);
      allow create, update: if isAdmin()
                            || (isAuthenticated() && request.resource.data.driver_id == request.auth.uid)
                            || (isAuthenticated() && request.resource.data.auto_update_flag == true);
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.driver_id == request.auth.uid);
    }

    // Driver Vehicles - Owner/admin
    match /driver_vehicles/{vehicleId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.driver_id == request.auth.uid);
      allow create, update: if isAdmin()
                            || (isAuthenticated() && request.resource.data.driver_id == request.auth.uid);
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.driver_id == request.auth.uid);
    }

    // Driver Wallets - Driver read, admin write
    match /driver_wallets/{walletId} {
      allow read: if isAdmin() || (isAuthenticated() && walletId == request.auth.uid);
      allow create: if isAuthenticated()
                    && walletId == request.auth.uid
                    && request.resource.data.balance <= 0;
      allow update, delete: if isAdmin();
    }

    // Driver Orders - Driver read own, admin manage
    match /driver_orders/{orderId} {
      allow read: if isAdmin() || (isAuthenticated() && (resource.data.driver_id == request.auth.uid || resource.data.customer_id == request.auth.uid));
      allow create: if isAdmin() || (isAuthenticated() && request.resource.data.customer_id == request.auth.uid);
      allow update, delete: if isAdmin();
    }

    // Driver Reviews - Public read, authenticated create
    match /driver_reviews/{reviewId} {
      allow read: if true;

      // Allow authenticated users to create reviews (for seeding or real reviews)
      allow create: if isAuthenticated();

      // Users can update their own reviews
      allow update: if isAuthenticated()
                    && resource.data.reviewer_id == request.auth.uid;

      // Only admins can delete reviews
      allow delete: if isAdmin();
    }

    // Driver Bookings - Driver and customer access
    match /driver_bookings/{bookingId} {
      allow read: if isAdmin()
                  || (isAuthenticated() && resource.data.driver_id == request.auth.uid)
                  || (isAuthenticated() && resource.data.customer_id == request.auth.uid);

      allow create: if isAuthenticated()
                    && request.resource.data.customer_id == request.auth.uid
                    && request.resource.data.status == 'pending';

      allow update: if isAdmin()
                    || (isAuthenticated() && resource.data.driver_id == request.auth.uid && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'driver_notes', 'updated_at']))
                    || (isAuthenticated() && resource.data.customer_id == request.auth.uid && request.resource.data.diff(resource.data).changedKeys().hasOnly(['customer_notes', 'updated_at']));

      allow delete: if isAdmin();
    }

    // Driver Application History - Track status changes
    match /driver_application_history/{historyId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.driver_id == request.auth.uid);
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // Pages Collection - Public read, admin write
    match /pages/{pageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Reviews Collection - Read all, authenticated write
    match /reviews/{reviewId} {
      allow read: if true;

      // Users can create reviews for their own bookings
      allow create: if isAuthenticated();

      // Users can update their own reviews
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      // Only admins can delete reviews
      allow delete: if isAdmin();
    }

    // Inquiries Collection - Create only, admin read
    match /inquiries/{inquiryId} {
      // Only admins can read inquiries
      allow read: if isAdmin();

      // Anyone can create inquiries (contact forms)
      allow create: if true;

      // Only admins can update or delete
      allow update, delete: if isAdmin();
    }

    // Newsletter Subscriptions - Create only
    match /newsletter/{subscriberId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Ayurveda Content - Public read, admin write
    match /ayurveda_content/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ayurveda Retreats - Public read, admin write
    match /ayurveda_retreats/{retreatId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ayurveda Treatments - Public read, admin write
    match /ayurveda_treatments/{treatmentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ayurveda Testimonials - Public read, admin write
    match /ayurveda_testimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // TEA TRAILS COLLECTIONS
    // ==========================================

    // Tea Trails Content - Public read, public write for seeding
    match /teatrails_content/{docId} {
      allow read: if true;
      allow write: if true;
    }

    // Tea Trails Tours - Public read, public write for seeding
    match /teatrails_tours/{tourId} {
      allow read: if true;
      allow write: if true;
    }

    // Tea Trails Routes - Public read, public write for seeding
    match /teatrails_routes/{routeId} {
      allow read: if true;
      allow write: if true;
    }

    // Tea Trails Gallery - Public read, public write for seeding
    match /teatrails_gallery/{imageId} {
      allow read: if true;
      allow write: if true;
    }

    // Tea Trails FAQs - Public read, public write for seeding
    match /teatrails_faqs/{faqId} {
      allow read: if true;
      allow write: if true;
    }

    // Tea Trails Testimonials - Public read, public write for seeding
    match /teatrails_testimonials/{testimonialId} {
      allow read: if true;
      allow write: if true;
    }

    // ==========================================
    // PILGRIMAGE TOURS COLLECTIONS
    // ==========================================

    // Pilgrimage Content - Public read, public write for seeding
    match /pilgrimage_content/{docId} {
      allow read: if true;
      allow write: if true;
    }

    // Pilgrimage Sites - Public read, public write for seeding
    match /pilgrimage_sites/{siteId} {
      allow read: if true;
      allow write: if true;
    }

    // Pilgrimage Tours - Public read, public write for seeding
    match /pilgrimage_tours/{tourId} {
      allow read: if true;
      allow write: if true;
    }

    // Pilgrimage Gallery - Public read, public write for seeding
    match /pilgrimage_gallery/{imageId} {
      allow read: if true;
      allow write: if true;
    }

    // Pilgrimage FAQs - Public read, public write for seeding
    match /pilgrimage_faqs/{faqId} {
      allow read: if true;
      allow write: if true;
    }

    // Pilgrimage Testimonials - Public read, public write for seeding
    match /pilgrimage_testimonials/{testimonialId} {
      allow read: if true;
      allow write: if true;
    }

    // Pilgrimage Guidelines - Public read, public write for seeding
    match /pilgrimage_guidelines/{guidelineId} {
      allow read: if true;
      allow write: if true;
    }

    // ==========================================
    // DRIVER BADGES & SOCIAL PROFILES
    // ==========================================

    // Driver Badges - Public read, admin/system write
    match /driver_badges/{badgeId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Driver Achievements - Public read, admin write
    match /driver_achievements/{achievementId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Driver Social Profiles - Public read, owner/admin write
    match /driver_social_profiles/{driverId} {
      allow read: if true;

      allow create: if isAuthenticated()
                    && driverId == request.auth.uid;

      allow update: if isAdmin()
                    || (isAuthenticated() && driverId == request.auth.uid);

      allow delete: if isAdmin();
    }

    // ==========================================
    // DRIVER BATCH OPERATIONS & ANALYTICS
    // ==========================================

    // Driver Batch Operations - Driver read own, admin full
    match /driver_batch_operations/{opId} {
      allow read: if isAdmin()
                  || (isAuthenticated() && resource.data.driver_id == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }

    // ==========================================
    // DRIVER PAYMENT SETTLEMENTS
    // ==========================================

    // Driver Payment Settlements - Driver read own, admin manage
    match /driver_payment_settlements/{settlementId} {
      allow read: if isAdmin()
                  || (isAuthenticated() && resource.data.driver_id == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }

    // Commission Settings - Admin only
    match /settings/commission_settings {
      allow read: if isAdmin() || isAuthenticated();
      allow write: if isAdmin();
    }

    // ==========================================
    // VENDOR PLATFORM
    // ==========================================

    // Helper function for vendor admin-only fields
    function vendorAdminOnlyFields() {
      return [
        'status',
        'isVerified',
        'isFeatured',
        'verificationDate',
        'verifiedByAdminId',
        'rejectionReason',
        'rating',
        'reviewCount',
        'totalBookings'
      ];
    }

    // Vendors Collection - Public read approved, admin full access
    match /vendors/{vendorId} {
      // Public can read verified vendors, admin can read all
      allow read: if isAdmin() || resource.data.status == 'approved';

      // Anyone can create a vendor application (registration is open)
      allow create: if request.resource.data.status == 'pending'
                    && !request.resource.data.keys().hasAny(vendorAdminOnlyFields());

      // Vendors can update their own non-admin fields, admin can do anything
      allow update: if isAdmin()
                    || (
                      isAuthenticated()
                      && resource.data.email == request.auth.token.email
                      && !request.resource.data.diff(resource.data).changedKeys().hasAny(vendorAdminOnlyFields())
                    );

      allow delete: if isAdmin();
    }

    // Vendor Services - Vendor and admin access
    match /vendor_services/{serviceId} {
      allow read: if true;

      allow create: if isAuthenticated()
                    && request.resource.data.vendor_id != null;

      allow update: if isAdmin()
                    || (isAuthenticated() && resource.data.vendor_id == request.auth.uid);

      allow delete: if isAdmin()
                    || (isAuthenticated() && resource.data.vendor_id == request.auth.uid);
    }

    // Vendor Bookings - Vendor, customer, and admin access
    match /vendor_bookings/{bookingId} {
      allow read: if isAdmin()
                  || (isAuthenticated() && resource.data.vendor_id == request.auth.uid)
                  || (isAuthenticated() && resource.data.customer_id == request.auth.uid);

      allow create: if isAuthenticated()
                    && request.resource.data.customer_id == request.auth.uid
                    && request.resource.data.status == 'pending';

      allow update: if isAdmin()
                    || (isAuthenticated() && resource.data.vendor_id == request.auth.uid && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'vendor_notes', 'updated_at']))
                    || (isAuthenticated() && resource.data.customer_id == request.auth.uid && request.resource.data.diff(resource.data).changedKeys().hasOnly(['customer_notes', 'updated_at']));

      allow delete: if isAdmin();
    }

    // Vendor Reviews - Public read, authenticated create
    match /vendor_reviews/{reviewId} {
      allow read: if true;

      allow create: if isAuthenticated()
                    && request.resource.data.reviewer_id == request.auth.uid
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5;

      allow update: if isAuthenticated()
                    && resource.data.reviewer_id == request.auth.uid;

      allow delete: if isAdmin();
    }

    // Vendor Application History - Track status changes
    match /vendor_application_history/{historyId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.vendor_id == request.auth.uid);
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // Vendor Payouts - Vendor read own, admin manage
    match /vendor_payouts/{payoutId} {
      allow read: if isAdmin()
                  || (isAuthenticated() && resource.data.vendor_id == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }

    // Vendor Messages - Vendor and customer access
    match /vendor_messages/{messageId} {
      allow read: if isAuthenticated()
                  && (resource.data.vendor_id == request.auth.uid || resource.data.customer_id == request.auth.uid || isAdmin());

      allow create: if isAuthenticated()
                    && (request.resource.data.sender_id == request.auth.uid);

      allow update: if isAuthenticated()
                    && (resource.data.vendor_id == request.auth.uid || resource.data.customer_id == request.auth.uid);

      allow delete: if isAdmin();
    }

    // Email Reminders - System use only
    match /email_reminders/{reminderId} {
      allow read: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Email Logs - Admin only
    match /emailLogs/{logId} {
      allow read: if isAdmin();
      allow create: if true; // Cloud Functions can create
      allow update, delete: if isAdmin();
    }

    // ==========================================
    // CMS COLLECTIONS
    // ==========================================

    // Hero Slides - Public read, admin write
    match /heroSlides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Book Now Hero Slides - Public read, admin write
    match /bookNowHeroSlides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Book Now Packages - Public read, admin write
    match /bookNowPackages/{packageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /whaleBookingContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /waterSportsBookingContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Testimonials - Public read, admin write
    match /testimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Page Content (About Sri Lanka, etc.) - Public read, admin write
    match /page-content/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Legacy camelCase page content collection
    match /pageContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // EXPERIENCE PAGE CONTENT COLLECTIONS
    // ==========================================

    // Whale Watching Page Content - Public read, admin write
    match /whaleWatchingPageContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Tea Trails Content - Public read, admin write
    match /teaTrailsContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ayurveda Content - Public read, admin write
    match /ayurvedaContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Pilgrimage Content - Public read, admin write
    match /pilgrimageContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Cooking Class Content - Public read, admin write
    match /cookingClassContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Waterfalls Content - Public read, admin write
    match /waterfallsContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Lagoon Safari Content - Public read, admin write
    match /lagoonSafariContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Island Getaways Content - Public read, admin write
    match /islandGetawaysContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Train Journeys Content - Public read, admin write
    match /trainJourneysContent/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Why Choose Us - Public read, admin write
    match /whyChooseUs/{featureId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Travel Packages - Public read, admin write
    match /travelPackages/{packageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Homepage Stats - Public read, admin write
    match /homepageStats/{statId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Featured Destinations - Public read, admin write
    match /featuredDestinations/{destinationId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Blog Posts - Public read, admin write
    match /blogPosts/{postId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Blogs Collection (Blog Manager) - Public read, admin write
    match /blogs/{blogId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Newsletter Config - Public read, admin write
    match /newsletterConfig/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Site Settings - Public read, admin write
    match /siteSettings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Site Settings (hyphenated) - Public read, admin write
    match /site-settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Settings Collection (Social Media config, etc.) - Public read, admin write
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Tourism News - Public read, admin/system write
    match /tourismNews/{articleId} {
      allow read: if true;
      allow write: if true; // Allow Cloud Functions to write
    }

    // Media Library - Public read, admin write
    match /mediaLibrary/{fileId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Experiences - Public read, admin write
    match /experiences/{experienceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Luxury Experiences - Public read, admin write
    match /luxuryExperiences/{experienceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Travel Guide Sections - Public read, admin write
    match /travelGuideSections/{sectionId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Destination Content - Public read, admin write
    match /destinationContent/{contentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Destination Map Attractions - Public read, admin write
    match /destinationMapAttractions/{attractionId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Destination Hero Slides - Public read, admin write
    match /destinationHeroSlides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // AIRPORT TRANSFER BOOKINGS
    // ==========================================

    // Airport Transfer Bookings - Public create, admin manage
    match /airportTransferBookings/{bookingId} {
      // Anyone can read their own booking (by email match), admin can read all
      allow read: if isAdmin() || resource.data.customerInfo.email == request.auth.token.email;

      // Anyone can create a booking (no authentication required for transfers)
      allow create: if true;

      // Only admins can update or delete bookings
      allow update, delete: if isAdmin();
    }

    // Counters - For sequential booking numbers (RT01205, RT01206, etc.)
    match /counters/{counterId} {
      // Anyone can read counters (needed for booking reference generation)
      allow read: if true;
      // Anyone can write counters (for transaction-based increments during booking)
      allow write: if true;
    }

    // ==========================================
    // CUSTOMERS CRM
    // ==========================================

    // Customer Profiles - Store all customer data
    match /customers/{customerId} {
      // Admin can read all customers, users can read their own profile
      allow read: if isAdmin() || request.auth != null && request.auth.uid == customerId;
      // Anyone can create a customer profile (during first booking)
      allow create: if true;
      // Only admins can update or delete customer profiles
      allow update, delete: if isAdmin();
    }

    // ==========================================
    // LUXURY PAGES & INQUIRIES
    // ==========================================

    // Luxury Pages Content - Public read, admin write
    match /luxuryPages/{pageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Helicopter Fleet - Public read, admin write
    match /helicopterFleet/{helicopterId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Helicopter Routes - Public read, admin write
    match /helicopterRoutes/{routeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Helicopter Inquiries - Public create, admin manage
    match /helicopterInquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Yacht Fleet - Public read, admin write
    match /yachtFleet/{yachtId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Yacht Destinations - Public read, admin write
    match /yachtDestinations/{destinationId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Yacht Inquiries - Public create, admin manage
    match /yachtInquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Jet Fleet - Public read, admin write
    match /jetFleet/{jetId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Jet Routes - Public read, admin write
    match /jetRoutes/{routeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Jet Inquiries - Public create, admin manage
    match /jetInquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Villa Collection - Public read, admin write
    match /villaCollection/{villaId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Villa Inquiries - Public create, admin manage
    match /villaInquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Vehicle Fleet - Public read, admin write
    match /vehicleFleet/{vehicleId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Vehicle Inquiries - Public create, admin manage
    match /vehicleInquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Dream Journey Inquiries - VIP public create, admin manage
    match /dreamJourneyInquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // VIP Concierge Inquiries - Public create, admin manage
    match /vipConciergeInquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Exclusive Access Inquiries - Public create, admin manage
    match /exclusiveAccessInquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Dream Journeys Collection - Public read, admin write
    match /dreamJourneys/{journeyId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // VIP Concierge Services - Public read, admin write
    match /vipConciergeServices/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // CONCIERGE BOOKING SYSTEM COLLECTIONS
    // ==========================================

    // Concierge Services - Public read, admin write
    match /concierge_services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Concierge Bookings - Public create, user read own, admin manage
    match /concierge_bookings/{bookingId} {
      // Anyone can read their own booking (by email match), admin can read all
      allow read: if isAdmin() || (isAuthenticated() && resource.data.email == request.auth.token.email);

      // Anyone can create a booking (no authentication required for VIP concierge)
      allow create: if true;

      // Only admins can update or delete bookings
      allow update, delete: if isAdmin();
    }

    // Concierge Content (hero, settings) - Public read, admin write
    match /concierge_content/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Exclusive Access Experiences - Public read, admin write
    match /exclusiveAccessExperiences/{experienceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Exclusive Access Hero - Public read, admin write
    match /exclusiveAccessHero/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Exclusive Access Categories - Public read, admin write
    match /exclusiveAccessCategories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Luxury Hotels Collection - Public read, admin write
    match /luxuryHotels/{hotelId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Luxury Apartments Collection - Public read, admin write
    match /luxuryApartments/{apartmentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Luxury Houses Collection - Public read, admin write
    match /luxuryHouses/{houseId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // PRIVATE TOURS COLLECTIONS
    // ==========================================

    // Private Tours CMS Content - Public read, admin write
    match /cmsContent/privateToursContent {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Private Tour Destinations - Public read, admin write
    match /privateTourDestinations/{destinationId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Private Tour Vehicles - Public read, admin write
    match /privateTourVehicles/{vehicleId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Private Tour Drivers - Public read, admin write
    match /privateTourDrivers/{driverId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Private Tour Packages - Public read, admin write
    match /privateTourPackages/{packageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Private Tour Extras - Public read, admin write
    match /privateTourExtras/{extraId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Private Tour Bookings - Public create, admin manage
    match /privateTourBookings/{bookingId} {
      // Anyone can read their own booking (by email match), admin can read all
      allow read: if isAdmin() || (isAuthenticated() && resource.data.customerEmail == request.auth.token.email);

      // Anyone can create a booking (no authentication required)
      allow create: if true;

      // Only admins can update or delete bookings
      allow update, delete: if isAdmin();
    }

    // ==========================================
    // GROUP TRANSPORT COLLECTIONS
    // ==========================================

    // Group Transport Vehicles - Public read, admin write
    match /groupTransportVehicles/{vehicleId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Group Transport Hero Slides - Public read, admin write
    match /groupTransportHeroSlides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Group Transport Driver Charges - Public read, admin write
    match /groupTransportDriverCharges/{chargeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Group Transport Settings (in cmsContent)
    match /cmsContent/groupTransportSettings {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Group Transport Bookings - Public create, admin manage
    match /groupTransportBookings/{bookingId} {
      // Anyone can read their own booking (by email match), admin can read all
      allow read: if isAdmin() || (isAuthenticated() && resource.data.customerEmail == request.auth.token.email);

      // Anyone can create a booking (no authentication required)
      allow create: if true;

      // Only admins can update or delete bookings
      allow update, delete: if isAdmin();
    }

    // ==========================================
    // AYURVEDA WELLNESS COLLECTIONS
    // ==========================================

    // Ayurveda Treatments - Public read, admin write
    match /ayurvedaTreatments/{treatmentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ayurveda Retreats - Public read, admin write
    match /ayurvedaRetreats/{retreatId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ayurveda Testimonials - Public read, admin write
    match /ayurvedaTestimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ayurveda Resorts - Public read, admin write
    match /ayurvedaResorts/{resortId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Ayurveda Page Settings (in cmsContent)
    match /cmsContent/ayurvedaPageSettings {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // WELLNESS & SPA COLLECTIONS
    // ==========================================

    // Wellness Packages - Public read, admin write
    match /wellnessPackages/{packageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Wellness Spa Services - Public read, admin write
    match /wellnessSpaServices/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Wellness Resorts - Public read, admin write
    match /wellnessResorts/{resortId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Wellness Testimonials - Public read, admin write
    match /wellnessTestimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Wellness Page Settings (in cmsContent)
    match /cmsContent/wellnessPageSettings {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // ROMANCE (WEDDINGS & HONEYMOONS) COLLECTIONS
    // ==========================================

    // Romance Wedding Packages - Public read, admin write
    match /romanceWeddingPackages/{packageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Romance Honeymoon Packages - Public read, admin write
    match /romanceHoneymoonPackages/{packageId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Romance Venues - Public read, admin write
    match /romanceVenues/{venueId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Romance Testimonials - Public read, admin write
    match /romanceTestimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Romance FAQs - Public read, admin write
    match /romanceFAQs/{faqId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Romance Page Settings (in cmsContent)
    match /cmsContent/romancePageSettings {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Fleet Vehicles Page Settings (in cmsContent)
    match /cmsContent/fleetPageSettings {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Romance Bookings - Public create, admin read/write
    match /romanceBookings/{bookingId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ==========================================
    // CUSTOM EXPERIENCE COLLECTIONS
    // ==========================================

    // Custom Experience Page Content - Public read, admin write
    match /customExperiencePage/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Custom Experience Submissions - Public create, admin read/write
    match /customExperienceSubmissions/{submissionId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ==========================================
    // TRIPADVISOR TOURS COLLECTION
    // ==========================================

    // TripAdvisor Tours - Public read, admin write
    match /tours_tripadvisor/{tourId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // GLOBAL TOURS COLLECTIONS
    // ==========================================

    // Global Tours - Public read, admin write
    match /globalTours/{tourId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Global Tour Bookings - Public create, admin read/write
    match /globalTourBookings/{bookingId} {
      allow create: if true;
      allow read: if isAdmin() || (request.auth != null && resource.data.customerEmail == request.auth.token.email);
      allow update, delete: if isAdmin();
    }

    // Global Tour Reviews - Public read approved, public create, admin manage
    match /globalTourReviews/{reviewId} {
      allow read: if resource.data.isApproved == true || isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Culinary Tours - Public read, admin write
    match /culinary_tours/{tourId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Culinary Reviews - Public read, public create, admin manage
    match /culinary_reviews/{reviewId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // Culinary Bookings - Public create, admin read/write
    match /culinary_bookings/{bookingId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // ==========================================
    // NOTIFICATION QUEUES (For Cloud Functions)
    // ==========================================

    // Email Queue - Admin only (Cloud Functions write)
    match /emailQueue/{emailId} {
      allow read, write: if isAdmin();
    }

    // WhatsApp Queue - Admin only (Cloud Functions write)
    match /whatsappQueue/{messageId} {
      allow read, write: if isAdmin();
    }

    // Stripe Checkouts - Public create, admin read
    match /stripeCheckouts/{checkoutId} {
      allow create: if true;
      allow read, update: if isAdmin();
    }

    // ==========================================
    // TRAIN BOOKING COLLECTIONS
    // ==========================================

    // Train Hero Slides - Public read, admin write
    match /trainHeroSlides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Train Scenic Routes - Public read, admin write
    match /trainScenicRoutes/{routeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Train Bookings - Public create, admin manage
    match /trainBookings/{bookingId} {
      // Anyone can read their own booking (by email match), admin can read all
      allow read: if isAdmin() || (isAuthenticated() && resource.data.customerInfo.email == request.auth.token.email);

      // Anyone can create a booking (no authentication required)
      allow create: if true;

      // Only admins can update or delete bookings
      allow update, delete: if isAdmin();
    }

    // Train Routes (legacy collection) - Public read, admin write
    match /trainRoutes/{routeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Train Booking Settings (in cmsContent)
    match /cmsContent/trainBookingSettings {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==========================================
    // B2B PORTAL COLLECTIONS
    // ==========================================

    // B2B Agencies - Registration public, self-read, admin manage
    match /b2b_agencies/{agencyId} {
      // Public can create (register)
      allow create: if true;
      
      // Agencies can read their own profile
      allow read: if isAdmin() || request.auth != null;
      
      // Only admins can update or delete agencies
      allow update, delete: if isAdmin();
    }

    // B2B Bookings - Agency create/read own, admin full access
    match /b2b_bookings/{bookingId} {
      // Admins can do everything
      allow read, write: if isAdmin();
      
      // Agencies can read their own bookings (via Cloud Function with JWT)
      allow read: if request.auth != null;
      
      // Agencies can create bookings (via Cloud Function with JWT)
      allow create: if request.auth != null;
    }

    // B2B Password Resets - Cloud Functions only
    match /b2b_password_resets/{resetId} {
      allow read, write: if isAdmin();
    }

    // WhatsApp Messages Queue (for B2B confirmations)
    match /whatsappMessages/{messageId} {
      allow read, write: if isAdmin();
    }

    // ==========================================
    // VEHICLE RENTAL COLLECTIONS
    // ==========================================

    // Vehicle Owners - Public create (registration), owner read/update own, admin full
    match /vehicle_owners/{ownerId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // Vehicles - Public read active, owner create/update own, admin full
    match /vehicles/{vehicleId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAdmin() || (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // Vehicle Documents - Owner read/write own, admin full
    match /vehicle_documents/{docId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow create, update: if isAdmin() || (isAuthenticated() && request.resource.data.ownerId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // Vehicle Pricing - Public read, owner/admin write
    match /vehicle_pricing/{pricingId} {
      allow read: if true;
      allow create, update: if isAdmin() || isAuthenticated();
      allow delete: if isAdmin();
    }

    // Vehicle Availability - Public read, owner/admin write
    match /vehicle_availability/{availId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAuthenticated();
    }

    // Vehicle Rental Bookings - Public create, customer/owner read own, admin full
    match /vehicle_bookings/{bookingId} {
      allow read: if isAdmin()
                  || (isAuthenticated() && resource.data.customerId == request.auth.uid)
                  || (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow create: if true;
      allow update: if isAdmin()
                    || (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // Vehicle Reviews - Public read, authenticated create, admin manage
    match /vehicle_reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.customerId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // Owner Earnings - Owner read own, admin full
    match /owner_earnings/{earningId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }

    // Vehicle Promo Codes - Public read active, admin full
    match /vehicle_promo_codes/{promoId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Customer Blacklist - Admin only
    match /customer_blacklist/{customerId} {
      allow read, write: if isAdmin();
    }

    // Seasonal Pricing - Public read, admin full
    match /seasonal_pricing/{pricingId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Fleet Maintenance - Owner read own, admin full
    match /fleet_maintenance/{maintenanceId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.ownerId == request.auth.uid);
      allow create, update: if isAdmin() || (isAuthenticated() && request.resource.data.ownerId == request.auth.uid);
      allow delete: if isAdmin();
    }

    // Default rule - Deny all access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
