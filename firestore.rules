rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // User profiles
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if false; // Users cannot be deleted via client
    }
    
    // User wallets
    match /userWallets/{walletId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.balance == 0 &&
        request.resource.data.status == 'active';
      allow update: if isAdmin(); // Only admin can update wallets directly
      allow delete: if false; // Wallets cannot be deleted
    }
    
    // Recharge transactions
    match /rechargeTransactions/{transactionId} {
      allow read: if isAuthenticated() && 
        (get(/databases/$(database)/documents/userWallets/$(resource.data.walletId)).data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
        get(/databases/$(database)/documents/userWallets/$(request.resource.data.walletId)).data.userId == request.auth.uid &&
        request.resource.data.status == 'pending';
      allow update: if isAdmin() || 
        (isAuthenticated() && 
         get(/databases/$(database)/documents/userWallets/$(resource.data.walletId)).data.userId == request.auth.uid &&
         resource.data.status == 'pending' &&
         request.resource.data.status in ['processing', 'cancelled']);
      allow delete: if false; // Transactions cannot be deleted
    }
    
    // Wallet payment methods
    match /walletPaymentMethods/{methodId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Wallet booking payments
    match /walletBookingPayments/{paymentId} {
      allow read: if isAuthenticated() && 
        (get(/databases/$(database)/documents/userWallets/$(resource.data.walletId)).data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
        get(/databases/$(database)/documents/userWallets/$(request.resource.data.walletId)).data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if false; // Booking payments cannot be deleted
    }
    
    // Tours
    match /tours/{tourId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Hotels
    match /hotels/{hotelId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Activities
    match /activities/{activityId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Drivers
    match /drivers/{driverId} {
      allow read: if true; // Public access for browsing
      allow create: if isAuthenticated() && request.auth.uid == driverId;
      allow update: if isOwner(driverId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Vehicles
    match /vehicles/{vehicleId} {
      allow read: if true; // Public access for browsing
      allow write: if isAuthenticated() && 
        (resource == null || resource.data.driverId == request.auth.uid || isAdmin());
    }
    
    // Bookings
    match /bookings/{bookingId} {
      allow read: if true; // Temporarily allow public read for testing
      allow create: if true; // Temporarily allow anyone to create bookings for testing
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         resource.data.driverId == request.auth.uid || 
         isAdmin());
      allow delete: if isAdmin();
    }
    
    // Reviews
    match /reviews/{reviewId} {
      allow read: if true; // Public access
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // CMS content
    match /cmsContent/{contentId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Articles/Blog
    match /articles/{articleId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Social media posts
    match /socialMediaPosts/{postId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // AI recommendations
    match /aiRecommendations/{recommendationId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if false; // Recommendations are immutable
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Newsletter subscriptions
    match /newsletterSubscriptions/{subscriptionId} {
      allow read: if isAdmin();
      allow create: if true; // Anyone can subscribe
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Wildlife data
    match /wildlifeData/{dataId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Destinations
    match /destinations/{destinationId} {
      allow read: if true; // Public access
      allow write: if isAdmin();
    }
    
    // Analytics events
    match /analyticsEvents/{eventId} {
      allow read: if isAdmin();
      allow create: if true; // Anyone can create analytics events
      allow update: if false; // Events are immutable
      allow delete: if false; // Events cannot be deleted
    }
    
    // Admin notifications
    match /adminNotifications/{notificationId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // System settings
    match /systemSettings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Luxury Experiences
    match /luxuryExperiences/{experienceId} {
      allow read: if true; // Public access for browsing
      allow write: if isAdmin();
    }
    
    // Custom Experience Requests
    match /customExperienceRequests/{requestId} {
      allow read: if isAdmin() ||
        (isAuthenticated() && resource.data.email == request.auth.token.email);
      allow create: if true; // Anyone can submit a request
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ==========================================
    // Landing Page CMS Collections
    // ==========================================

    // Hero Slides - Homepage hero section carousel
    match /heroSlides/{slideId} {
      allow read: if true; // Public access for landing page
      allow write: if isAdmin(); // Only admins can manage hero slides
    }

    // Site Settings - Global site configuration including hero images
    match /site-settings/{settingId} {
      allow read: if true; // Public access for site content
      allow write: if isAdmin(); // Only admins can modify settings
    }

    // Testimonials - Customer reviews and testimonials
    match /testimonials/{testimonialId} {
      allow read: if true; // Public access for displaying testimonials
      allow write: if isAdmin(); // Only admins can manage testimonials
    }

    // About Sri Lanka - About section content
    match /aboutSriLanka/{contentId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admins can edit about content
    }

    // Why Choose Us - Benefits and features section
    match /whyChooseUs/{featureId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admins can manage features
    }

    // Travel Packages - Tour packages and itineraries
    match /travelPackages/{packageId} {
      allow read: if true; // Public access for browsing packages
      allow write: if isAdmin(); // Only admins can manage packages
    }

    // Featured Destinations - Homepage featured destinations
    match /featuredDestinations/{destinationId} {
      allow read: if true; // Public access for browsing
      allow write: if isAdmin(); // Only admins can manage featured destinations
    }

    // Blog Posts - Blog articles and posts (extends articles collection)
    match /blogPosts/{postId} {
      allow read: if true; // Public access for reading blog posts
      allow write: if isAdmin(); // Only admins can create/edit blog posts
    }

    // Newsletter Configuration - Newsletter section settings
    match /newsletterConfig/{configId} {
      allow read: if true; // Public access for newsletter form
      allow write: if isAdmin(); // Only admins can configure newsletter
    }

    // Homepage Stats - Dynamic statistics and numbers
    match /homepageStats/{statId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only admins can update stats
    }

    // Media Library - Uploaded images and media files
    match /mediaLibrary/{mediaId} {
      allow read: if true; // Public access to view media
      allow write: if isAdmin(); // Only admins can manage media
    }
  }
}